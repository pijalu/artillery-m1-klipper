# ===================================
# Artillery M1 - Print and LCD macros
# ===================================

[save_variables]
filename: ~/printer_data/config/variables.cfg
[idle_timeout]
[RESPOND]


[gcode_macro _USER_VARIABLES]
variable_name_printer : 'M1 PRO'
variable_autolevel: 0
variable_shapper: 0
variable_x_p_min: 5
variable_y_p_min: 5
variable_x_p_max: 255
variable_y_p_max: 255
variable_x_probe_count: 6
variable_y_probe_count: 6
variable_algorithm: 0
variable_unload_temp: 0
variable_unload_flag: 0
variable_adjust_retract: 0
variable_retract_value: 0
gcode:

#;========================================================================================================================================

#;=================================================== DEBUG ==============================================================================

#;========================================================================================================================================

[gcode_macro _TEST]

gcode:
    respond TYPE=echo MSG=" etat = {printer.idle_timeout.state}  etat pause = {printer.pause_resume.is_paused}"
    respond TYPE=echo MSG=" pos X = {printer.gcode_move.position.x} pos Y= {printer.gcode_move.position.y}"
    respond TYPE=echo MSG=" homing_X = {printer.gcode_move.homing_origin.x}   homing_Y = {printer.gcode_move.homing_origin.x}   homing_Z = {printer.gcode_move.homing_origin.x}"
    respond TYPE=echo MSG=" mode XY absolu= {(printer.gcode_move.absolute_coordinates)}  mode E absolu= {(printer.gcode_move.absolute_extrude)}"
    respond TYPE=echo MSG=" temperature extruder = {printer.extruder.temperature} temperature cible extruder = {printer.extruder.target}"    
    respond TYPE=echo MSG="Display_status = {printer.display_status.message}"
   
#;========================================================================================================================================

#;=============================TESTS OPTIONS MENUS before printing =======================================================================

#;========================================================================================================================================

[gcode_macro PRINTING_OPTIONS]
description : Options for enabling autolevel and shaper tests.
gcode:
      RESPOND TYPE=command MSG="action:prompt_begin PRINTING OPTIONS"
      RESPOND TYPE=command MSG="action:prompt_text , click on your printing options to change them."
      RESPOND TYPE=command MSG="action:prompt_button ONLY PRINT|_ONLY_PRINT|primary"
      RESPOND TYPE=command MSG="action:prompt_button AUTOLEVEL AND PRINT|_AUTOLEVEL_AND_PRINT|primary"
      RESPOND TYPE=command MSG="action:prompt_button SHAPER AND PRINT|_SHAPER_AND_PRINT|primary"
      RESPOND TYPE=command MSG="action:prompt_button AUTOLEVEL, SHAPER AND PRINT|_AUTOLEVEL_AND_SHAPER_AND_PRINT|primary"
      RESPOND TYPE=command MSG="action:prompt_button VALIDATE MESH OPTIONS|_CHOICE_VALIDATE_MESH|primary"
 #     RESPOND TYPE=command MSG="action:prompt_button Active_DEBUG|SAVE_VARIABLE VARIABLE=f_debug VALUE='1'|primary" 
 #     RESPOND TYPE=command MSG="action:prompt_button No_DEBUG|SAVE_VARIABLE VARIABLE=f_debug VALUE='0'|primary"
      RESPOND TYPE=command MSG="action:prompt_show"



[gcode_macro _CHOICE_VALIDATE_MESH]
#By disabling automatic leveling, you can allow a quick test of the saved mesh. If the test is negative, a new mesh will be created.
#Set the maximum acceptable deviation or reject the test.
gcode:
      RESPOND TYPE=command MSG="action:prompt_begin VALIDATE MESH OPTION"
      RESPOND TYPE=command MSG="action:prompt_text  By disabling automatic leveling, you can allow a quick test of the saved mesh"
      RESPOND TYPE=command MSG="action:prompt_text  If the test is negative, a new mesh will be created."
      RESPOND TYPE=command MSG="action:prompt_text  Set the maximum deviation tolerance, or reject the test."
      RESPOND TYPE=command MSG="action:prompt_button Â±0.03| SAVE_VARIABLE VARIABLE=max_deviation VALUE='0.03'|primary"
      RESPOND TYPE=command MSG="action:prompt_button Â±0.04| SAVE_VARIABLE VARIABLE=max_deviation VALUE='0.04'|primary"
      RESPOND TYPE=command MSG="action:prompt_button Â±0.05| SAVE_VARIABLE VARIABLE=max_deviation VALUE='0.05'|primary"
      RESPOND TYPE=command MSG="action:prompt_button Â±0.06| SAVE_VARIABLE VARIABLE=max_deviation VALUE='0.06'|primary"
      RESPOND TYPE=command MSG="action:prompt_button Â±0.07| SAVE_VARIABLE VARIABLE=max_deviation VALUE='0.07'|primary"
      RESPOND TYPE=command MSG="action:prompt_button Â±0.08| SAVE_VARIABLE VARIABLE=max_deviation VALUE='0.08'|primary"
      RESPOND TYPE=command MSG="action:prompt_button NO_TEST| SAVE_VARIABLE VARIABLE=max_deviation VALUE='0'|primary"
      RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _AUTOLEVEL_OPTIONS]
gcode:
      RESPOND TYPE=command MSG="action:prompt_begin AUTOLEVEL OPTIONS"
      RESPOND TYPE=command MSG="action:prompt_text  - BED_MESH will mesh the entire bed surface."
      RESPOND TYPE=command MSG="action:prompt_text  - ADAPTIVE MESH only covers the printed surface with a margin"
      RESPOND TYPE=command MSG="action:prompt_text  - two possibilities in adaptive mesh :"
      RESPOND TYPE=command MSG="action:prompt_text  -   ADAPTIVE MESH MOD  parameters define here"
      RESPOND TYPE=command MSG="action:prompt_text  -   ADAPTIVE MESH ORCA parameters from profil printer ORCA"
      RESPOND TYPE=command MSG="action:prompt_text  - The next screen will configure either option."
      RESPOND TYPE=command MSG="action:prompt_button BED MESH|_BED_MESH_OPTIONS|primary"
      RESPOND TYPE=command MSG="action:prompt_button ADAPTIVE MESH MOD|_ADAPTIVE_MESH_OPTIONS|primary"
      RESPOND TYPE=command MSG="action:prompt_button ADAPTIVE MESH ORCA|_ADAPTIVE_MESH_ORCA|primary"
      RESPOND TYPE=command MSG="action:prompt_show"



[gcode_macro _ADAPTIVE_MESH_ORCA]
gcode:
       SAVE_VARIABLE VARIABLE=autolevel VALUE='2'



[gcode_macro _BED_MESH_OPTIONS]
gcode:
      SAVE_VARIABLE VARIABLE=adaptive_mesh VALUE='0'
      RESPOND TYPE=command MSG="action:prompt_begin BED MESH OPTIONS"
      RESPOND TYPE=command MSG="action:prompt_text  - Choose the mesh size."
      RESPOND TYPE=command MSG="action:prompt_button 5X5|SAVE_VARIABLE VARIABLE=bedmesh_count VALUE='5'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 6X6|SAVE_VARIABLE VARIABLE=bedmesh_count VALUE='6'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 7X7|SAVE_VARIABLE VARIABLE=bedmesh_count VALUE='7'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 8X8|SAVE_VARIABLE VARIABLE=bedmesh_count VALUE='8'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 9X9|SAVE_VARIABLE VARIABLE=bedmesh_count VALUE='9'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 10X10|SAVE_VARIABLE VARIABLE=bedmesh_count VALUE='10'|primary"
      RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _ADAPTIVE_MESH_OPTIONS]
gcode:
      SAVE_VARIABLE VARIABLE=adaptive_mesh VALUE='1'
      RESPOND TYPE=command MSG="action:prompt_begin ADAPTIVE MESH OPTIONS"
      RESPOND TYPE=command MSG="action:prompt_text  - Choose point spacing in mm, X axis."
      RESPOND TYPE=command MSG="action:prompt_button 5| SAVE_VARIABLE VARIABLE=x_spacing_points VALUE='5'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 10| SAVE_VARIABLE VARIABLE=x_spacing_points VALUE='10'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 15| SAVE_VARIABLE VARIABLE=x_spacing_points VALUE='15'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 20| SAVE_VARIABLE VARIABLE=x_spacing_points VALUE='20'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 25| SAVE_VARIABLE VARIABLE=x_spacing_points VALUE='25'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 35| SAVE_VARIABLE VARIABLE=x_spacing_points VALUE='35'|primary"
      RESPOND TYPE=command MSG="action:prompt_text  - Choose point spacing in mm, Y axis."
      RESPOND TYPE=command MSG="action:prompt_button 5| SAVE_VARIABLE VARIABLE=y_spacing_points VALUE='5'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 10| SAVE_VARIABLE VARIABLE=y_spacing_points VALUE='10'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 15| SAVE_VARIABLE VARIABLE=y_spacing_points VALUE='15'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 20| SAVE_VARIABLE VARIABLE=y_spacing_points VALUE='20'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 25| SAVE_VARIABLE VARIABLE=y_spacing_points VALUE='25'|primary"
      RESPOND TYPE=command MSG="action:prompt_button 35| SAVE_VARIABLE VARIABLE=y_spacing_points VALUE='35'|primary"
      RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _SAV_FLAG]
description : save flags for autolevel and shaper in the variables file
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _SAV_FLAG {params}}"
    {% set flag_level= params.AUTOLEVEL %}
    {% set flag_shapper= params.SHAPPER %}

    SAVE_VARIABLE VARIABLE=autolevel VALUE={flag_level}
    SAVE_VARIABLE VARIABLE=shapper VALUE={flag_shapper}


[gcode_macro _AUTOLEVEL_AND_SHAPER_AND_PRINT]
description: Create flag autolevel and shapper
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _AUTOLEVEL_AND_SHAPPER_AND_PRINT {params}"

    {% set flag_level = 1 %}
    {% set flag_shapper = 1 %}
    _SAV_FLAG AUTOLEVEL={flag_level} SHAPPER={flag_shapper}
    respond TYPE=command    MSG="Autolevel = '{flag_level}'        Shapper = '{flag_shapper}'"
    _AUTOLEVEL_OPTIONS

[gcode_macro _AUTOLEVEL_AND_PRINT]
description: Create flag autolevel and shapper
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : AUTOLEVEL_AND_PRINT {params}"
    {% set flag_level = 1 %}
    {% set flag_shapper = 0 %}
    _SAV_FLAG AUTOLEVEL={flag_level} SHAPPER={flag_shapper}
    respond TYPE=command    MSG="Autolevel = '{flag_level}'        Shapper = '{flag_shapper}'"
    _AUTOLEVEL_OPTIONS

[gcode_macro _SHAPER_AND_PRINT]
description: Create flag autolevel and shapper
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _SHAPPER_AND_PRINT {params}"
    {% set flag_level = 0 %}
    {% set flag_shapper = 1 %}
    _SAV_FLAG AUTOLEVEL={flag_level} SHAPPER={flag_shapper}
    respond TYPE=command    MSG="Autolevel = '{flag_level}'        Shapper = '{flag_shapper}'"
    _CHOICE_VALIDATE_MESH

[gcode_macro _ONLY_PRINT]
description: Create flag autolevel and shapper
gcode:
  RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : ONLY_PRINT {params}"
    {% set flag_level = 0 %}
    {% set flag_shapper = 0 %}
    _SAV_FLAG AUTOLEVEL={flag_level} SHAPPER={flag_shapper}
    respond TYPE=command    MSG="Autolevel = '{flag_level}'        Shapper = '{flag_shapper}'"
    _CHOICE_VALIDATE_MESH

  
#;====================================================================================================================================================
#
#;=========================================MACROS PROCESS START_GCODE=================================================================================
#
#;====================================================================================================================================================



[gcode_macro DIY_PREPARE]
description: Prepare printing
gcode:
   RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : DIY_PREPARE {params}"
    {% if params.GCODE_MACRO_A %}
     {%set macro_a= params.GCODE_MACRO_A|default() %}
     _{macro_a}
    {% endif %}
  

[gcode_macro DIY_START]
description: Execute specified macro before initiating print
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : DIY_START {params}"
    {% set svv=printer.save_variables.variables %}
    {% set debug = params.AUTOLEVEL|default(svv.autolevel)|int %}

    {% set user_vars = printer["gcode_macro _USER_VARIABLES"] %}
    
    LOG_MACRO NAME="DIY_START {params.FILENAME}" 
    {% set user_vars = printer["gcode_macro _USER_VARIABLES"] %}
    respond TYPE=command MSG='{user_vars.name_printer}' 
    SET_DISPLAY_TEXT
    {% set filename = params.FILENAME %}
    SDCARD_FILE_TO_PRINT FILE='{filename}'
    SDCARD_PRINT_FILE FILENAME='{filename}'

[gcode_macro _DIY_INIT_START]
description : Preparations before printing for insertion into the slicer's start_gcode

gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : DIY_INIT_START {params}"
     #init debug
    {% set svv=printer.save_variables.variables %}
    {% set debug = svv.autolevel %}
    {% set user_vars = printer["gcode_macro _USER_VARIABLES"] %}
   
    {% set user_vars = printer["gcode_macro _USER_VARIABLES"] %}
    {% set ssv=printer.save_variables.variables %}
    {% set autolevel = params.AUTOLEVEL|default(ssv.autolevel)|int %}
    {% set shapper   = params.SHAPPER|default(ssv.shapper)|int %}
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_0}"
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_1}"
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_2}"
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_3}"
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_4}"
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_5}"
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_6}"
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=retract VALUE="{svv.retract_value_filament_7}"
    SET_FILAMENT_SENSOR SENSOR=hall_fila_switch ENABLE=1
    CLEAR_PAUSE
    SDCARD_DIY_STATUS STATE='STEP_PRINT_PREPARE'
    ;===== Prepare LCD STEPS =====================
    {% if autolevel == 1 %}
    SDCARD_IF_LEVEL STATE='TRUE'
    {% else %}
    SDCARD_IF_LEVEL STATE='FALSE'
    {% endif %}

    {% if shapper == 1 %}
    SDCARD_IF_SHAPE STATE='TRUE'
    {% else %}
    SDCARD_IF_SHAPE STATE='FALSE'
    {% endif %}

    ;===== Default Settings =====================
   
    M106 S0  ;turn off cool fan
    M141 S0  ;turn off PTC
    M106 P2 S0  ;turn off chamber fan
    M106 P1 S0  ;turn off PTC fan
    M106 P3 S0  ;turn off filter fan
    M220 S100 ;Reset Feedrate
    M221 S100 ;Reset Flowrate
    SET_VELOCITY_LIMIT VELOCITY=500;
    SET_VELOCITY_LIMIT ACCEL=6000;
    SET_VELOCITY_LIMIT MINIMUM_CRUISE_RATIO=0.2;
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5;
    G21; set units to millimeters
    G90


[gcode_macro _DIY_HEATING_CHAMBER]
description : Preparations before printing for insertion into the slicer's start_gcode

#====================Preheating chamber================================================================
#The list is not exhaustive, only filaments that do not require a heated #chamber (0Â°C are excluded).  # 
#So check your settings in the filament profiles,  For the moment, only the final temperature of the   #
# chamber is the objective.                                                                            #
#=======================================================================================================
gcode: 
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _DIY_HEATING_CHAMBER {params}"
    {% set temp_chamber=params.CHAMBER_TEMP|int %}
    {% if temp_chamber != 0 %}  
        respond TYPE=command MSG='Preheating the chamber'
              M106 P1 S255
              M106 P2 S60
              G4 P5000
              {% if temp_chamber >= 47 %}
              M191 S47           
              {% endif %}
              M141 S{temp_chamber}
    {% endif %}

[gcode_macro _FIRST_LINE] 
description: ===== Wipe Nozzle Extrude Line =====================
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _FIRST_LINE {params}"
    {% set flpmx = params.FLPM_X %}
    {% set flpmy = params.FLPM_Y %}
    G1 X-1.2 Y5 Z0 F18000
    M400

    G92 E0
    G0  E4
    M400

    G92 E0
    G1 X-1.2 Y220 Z0.2 F1800.0 E11.0
    M400

    G92 E0
    G1 X-0.7
    G0 E0.2
    M400


    G92 E0
    G1 X-0.7 Y30 F1800.0 E11;
    M400
    
    G1 E-0.3
    G1 Y10 Z0.06
    
    M400
    G92 E0
    G1 Z0.6 F600
    M400
    G1 X{flpmx} Y{flpmy} F9000
    M400

[gcode_macro _DIY_AUTOTEST]
description:  Autolevel et shapper on request.
# Optional parameters:
#   AUTOLEVEL : 0 (skip), 1 (run) - use saved value otherwise
#   SHAPPER   : 0 (skip), 1 (run) - use saved value otherwise

# The two tests are even active from the "PRINTING_OPTIONS" macros available in FLUIDD.
#The autolevel options can be configured in the "AUTOLEVEL_OPTIONS" macro.
# The activation of the tests is stored in a "variables.cfg" file, so they are active until modified.
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _DIY_AUTOTEST {params}"

    {% set svv=printer.save_variables.variables %}
    {% set autolevel = params.AUTOLEVEL|default(svv.autolevel)|int %}
    {% set shapper   = params.SHAPPER|default(svv.shapper)|int %}
    {% set max_deviation = svv.max_deviation|float %}

    SDCARD_DIY_STATUS STATE='STEP_AUTO_LEVELING'
    M106 S0
    G28
    {% if autolevel == 1 %}
         BED_MESH_CLEAR
         _DIY_BED_MESH_CALIBRATE X_P_MIN={params.X_P_MIN} Y_P_MIN={params.Y_P_MIN} X_P_MAX={params.X_P_MAX} Y_P_MAX={params.Y_P_MAX} 
         SAVE_DATA
    {% elif autolevel == 2 %}
         BED_MESH_CLEAR
         BED_MESH_CALIBRATE mesh_min={params.X_P_MIN},{params.Y_P_MIN} mesh_max={params.X_P_MAX},{params.Y_P_MAX} ALGORITHM=[bed_mesh_algo] PROBE_COUNT={printer["USER_VARIABLES"].x_probe_count},{printer["USER_VARIABLES"].y_probe_count} ADAPTIVE=1 ADAPTIVE_MARGIN=0
         SAVE_DATA
    {% else %}
         # Only validate mesh (stop fan as well)
         {% if not(max_deviation == 0) %}
            VALIDATE_BED_MESH mesh_min={params.X_P_MIN},{params.Y_P_MIN} mesh_max={params.X_P_MAX},{params.Y_P_MAX} SAVE_CONFIG=false MAX_DEVIATION={max_deviation}
         {% endif %}
    {% endif %}

    M106 P2 S0
    G4 P500
    G0 Z10 F1800
    G0 X133 Y133 F12000
    {% if shapper == 1 %}  
      SDCARD_DIY_STATUS STATE='STEP_SHARPER_CALIBRATE'
      SHAPER_CALIBRATE
    {% endif %}
    SDCARD_DIY_STATUS STATE='STEP_PRINTING'


[gcode_macro _DIY_CLEAN_NOZZLE]
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _DIY_CLEAN_NOZZLE {params}"
    {% set temp_buse =params.TEMP|int %}
    SDCARD_DIY_STATUS STATE='STEP_CLEAN_NOZZLE'
    M109 S140
    G28     #necessaire pour appeldepuis ecran
    G90
    G1 X200 Y260 F6000
    G1 X200 Y275 F6000
    G1 X160 Y275 F6000
    G1 X137 Y275 F3000
    M400
    ;===== Extrude filament ===================================
    M109 S{temp_buse}  
    M400
    M83
    G1 E40 F300
    M400
    ;============ Cool down, extrude, cool down ==================
    # M109 S230;M104 S{temp_buse}
    G1 E40 F250
    G1 E-2 F600
    M400
    M106 S120
    G4 P1000
    M109 S{temp_buse - 20}
    ;===== Scrape material at discharge port =============================
    M106 S160
    G4 P1000
    G1 X170 Y275 F30000
    G1 X138 Y275 F3000 
    G1 X170 Y275 F30000
    G1 X138 Y275 F3000
    G1 X170 Y275 F30000
    M106 S0
    M400
    ;===== Brush nozzle ==============================
    M106 S255
    G4 P1000
    G1 X153 Y269.5 Z5 F2000
    ;===== Fine-tune Z ================================
    G1 X153 Y269.5 Z0.5 F3000
    G1 X186 Y269.5 Z0.5 F3000
    G1 X153 Y269 Z0.5 F3000
    G1 X186 Y269 Z0.5 F3000
    G1 X153 Y268.5 Z0.5 F3000
    G1 X186 Y268.5 Z0.5 F3000

    M400
    G1 Z3 F300
    M400
    ;===== Nozzle sealing and cooling =============================
    M106 S220
    M104 S{temp_buse - 50}
    G1 X193 Y269 Z2 F3000
    M400
    G1 X193 Y269 Z1 F1000
    G1 X200 Y269 Z0 F80
    G1 X205 Y269 Z0 F80
    M400
    G1 X205 Y269 Z-0.2 F60
    M109 S140
    G1 X215 Y269 Z1 F600
    G1 Z5 F3000
    M400
    M106 S150


;======================================= AUTOLEVEL BY Daniel Sauvage  =======================================================================
;These macros allow you to customize the mesh of either the entire bed or to adapt it to the print surface .
;You will thus have the choice between speed or precision.
;This is not the usual adaptive mesh since it is configurable to your liking,
;customizable in ORCA by accessing FLUIDD and the "AUTOLEVEL_OPTIONS" macro before sending
;the g-code to the printer. 
;The configuration is active until it is changed.
;You can configure  settings in Fluidd and print from Artilery Slicer or the printer screen.
;Per axis, the number of measurement points cannot be less than 4 and greater than 10.
;Their number will be automatically corrected if exceeded, and the spacing will be recalculated.
;It automatically adapts to the dimensions of the bed or objects to be printed, so it works on all klipper printers.
;=======================================================================================================================================
[gcode_macro _DIY_BED_MESH_CALIBRATE]

gcode:
        RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _DIY_BED_MESH_CALIBRATE {params}"

           {% set svv = printer.save_variables.variables %}
           {% set adap_mesh = svv.adaptive_mesh|int %} 

           {% if (svv.adaptive_mesh|int) == 1 %}
                #adaptive mesh
                      
                {% set x_mesh_min, y_mesh_min = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
                {% set x_mesh_max, y_mesh_max = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
      
                {% set x_pri_min = params.X_P_MIN|default(x_mesh_min)|float %}
                {% set y_pri_min = params.Y_P_MIN|default(y_mesh_min)|float %}
                {% set x_pri_max = params.X_P_MAX|default(x_mesh_max)|float %} 
                {% set y_pri_max = params.Y_P_MAX|default(y_mesh_max)|float %}

                {% set margin   = svv.adaptive_margin|default(0)|float %}

                {% set x_pri_min = (x_pri_min - margin) %}
                {% if x_pri_min < x_mesh_min %}
                      {% set x_pri_min = x_mesh_min %}
                {% endif %}

                {% set y_pri_min = (y_pri_min - margin) %}
                {% if y_pri_min < y_mesh_min %}
                      {% set  y_pri_min = y_mesh_min %}
                {% endif %}

                {% set x_pri_max = x_pri_max + margin %}
                {% if x_pri_max > x_mesh_max %}
                      {% set x_pri_max = x_mesh_max %}
                {% endif %}

                {% set y_pri_max = y_pri_max + margin %}
                {% if y_pri_max > y_mesh_max %}
                      {% set y_pri_max = y_mesh_max %}
                {% endif %}
            
                {% set x_spacing_points = svv.x_spacing_points|default(5)  %}
                {% set x_count = ((x_pri_max - x_pri_min) / x_spacing_points)| round(method='ceil') | int + 1 %}

                {% set y_spacing_points = svv.y_spacing_points|default(5)  %}
                {% set y_count = ((y_pri_max - y_pri_min) / y_spacing_points)| round(method='ceil') | int + 1 %}

            {% else %}
                # BED_MESH
                {% set x_pri_min, y_pri_min = printer["configfile"].config["bed_mesh"]["mesh_min"].split(',')|map('trim')|map('int') %}
                {% set x_pri_max, y_pri_max = printer["configfile"].config["bed_mesh"]["mesh_max"].split(',')|map('trim')|map('int') %}
                {% set x_probe_count, y_probe_count = printer["configfile"].config["bed_mesh"]["probe_count"].split(',')|map('trim')|map('int') %}

                {% set x_count = svv.bedmesh_count|default(x_probe_count)|int %}
                {% set y_count = svv.bedmesh_count|default(y_probe_count)|int %}   

            {% endif %} 
                #Formatting parameters
                {% if x_count > 10 %}
                      {% set  x_count = 10 %}
                {% endif %}
                {% if x_count < 4 %}
                      {% set  x_count = 4 %}
                {% endif %}     
                {% if y_count > 10 %}
                      {% set y_count = 10 %}
                {% endif %}     
                {% if y_count < 4 %}
                      {% set y_count = 4 %}
                {% endif %}     

            {% set mesh_min = "%d,%d"|format(x_pri_min, y_pri_min) %}
            {% set mesh_max = "%d,%d"|format(x_pri_max, y_pri_max) %}
            {% set probe_count = "%d,%d"|format(x_count, y_count) %}
            BED_MESH_CALIBRATE MESH_MIN={mesh_min} MESH_MAX={mesh_max} PROBE_COUNT={probe_count}
