# =================================
# Artillery M1 - General macros
# =================================

[gcode_macro M141]
# rename_existing: m1416
gcode:
    {% set s = params.S|float %}
    {% set temp = (params.S|default(0)|int,0)|max %}
    {% if temp>0 %}
      # SET_FAN_SPEED FAN=_ptc_fan SPEED=1
      SET_HEATER_TEMPERATURE HEATER=chamber TARGET="{temp}"
    {% else %}
      # SET_FAN_SPEED FAN=_ptc_fan SPEED=0
      SET_HEATER_TEMPERATURE HEATER=chamber TARGET=0
    {% endif %}

[gcode_macro M191]
gcode:
    {% set s = params.S|float %}
    {% if s == 0 %}
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={s}
        M106 P1 S0
    {% else %}
        SET_HEATER_TEMPERATURE HEATER=chamber TARGET={s}
        TEMPERATURE_WAIT SENSOR="heater_generic chamber" MINIMUM={s-2} MAXIMUM={s+2}
        M106 P1 S255
    {% endif %}

[homing_override]
set_position_z: 260
set_position_x: 110
set_position_y: 110
gcode:
    {% set X_HOME = printer.configfile.settings['stepper_x'].position_endstop|int %}
    {% set Y_HOME = printer.configfile.settings['stepper_y'].position_endstop|int %}
    {% set X_TARGET = params.X|default(X_HOME + 132)|int %}
    {% set Y_TARGET = params.Y|default(Y_HOME + 132)|int %}
    {% set RUN_CUR = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set keys_str = params.keys()|join('') %}
    {% set has_z = 'Z' in keys_str or 'z' in keys_str %}
    {% set has_x = 'X' in keys_str or 'x' in keys_str %}
    {% set has_y = 'Y' in keys_str or 'y' in keys_str %}

    {% macro home_axis(axis) -%}
        {% set stepper = 'stepper_' ~ axis %}
        SET_TMC_CURRENT STEPPER={stepper} CURRENT=0.7
        M400
        G28 {axis}
        G91
        G1 {axis}5 F3000
        M400
        G90
        SET_TMC_CURRENT STEPPER={stepper} CURRENT={RUN_CUR}
    {%- endmacro %}

    {% if has_z or (params|length == 1) %}
        M106 S0# Yuntu machine Z-axis probing is affected by fan vibration, need to ensure fan is off
        G91
        G1 Z5 F120
        G90
        
        { home_axis('y') }
        { home_axis('x') }
        { home_axis('y') }
        { home_axis('x') }
        
        G1 X{X_TARGET} Y{Y_TARGET} F3000
        G28 Z
        G1 Z10 F300
        
    {% else %}
        {% if has_y %}
        { home_axis('y') }
        {% endif %}
        {% if has_x %}
        { home_axis('x') }
        {% endif %}
        {% if has_y %}
        { home_axis('y') }
        {% endif %}
        {% if has_x %}
        { home_axis('x') }
        {% endif %}
    {% endif %}
    M400
    G90

[gcode_macro PRINT_START]         
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
	  G92 E0                                         
	  G90             
    CLEAR_PAUSE
    M117 Printing                   
    
[gcode_macro PRINT_END]
gcode:
    {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
    {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
    # {% set RUN_DECEL    = printer.configfile.settings['printer'].max_accel_to_decel|float %}
    SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} #ACCEL_TO_DECEL={RUN_DECEL}
    M220 S100
    M221 S100
    {% set z = params.Z|default(100)|int %}
    {% if (printer.gcode_move.position.z+5) < z %}
    G90 							            ; absolute positioning
    G1 Z{z+5} F6000 				      ; park nozzle at rear
    {% endif %}
    TURN_OFF_HEATERS
    M107
    M84


[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
      SET_DISPLAY_TEXT
      {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
      {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
      # {% set RUN_DECEL    = printer.configfile.settings['printer'].max_accel_to_decel|float %}
      SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} #ACCEL_TO_DECEL={RUN_DECEL}
      {% set z = params.Z|default(100)|int %}  
      {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
      {% set y_park = params.Y|default(printer.toolhead.axis_minimum.y+5)|int %} 
      SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} 
      SDCARD_RESET_FILE
      M400
      M220 S100
      M221 S100
      G91
      M83
      G1 E-1.0 F1200
      TURN_OFF_HEATERS
      M106 S0
      M141 S0
      M106 P2 S0
      M106 P1 S0
      M106 P3 S0
      M107
      {% if (printer.gcode_move.position.z+5) < z %}
      G90
      G0 X{x_park} Y{y_park} Z{z+5} F6000
      {% endif %}
      {%if (printer.gcode_move.position.z+5) >= z %}
      {%if (printer.gcode_move.position.z+5) < printer.toolhead.axis_maximum.z %}
      G91
      G1 Z5 F300
      G90
      G0 X{x_park} Y{y_park} F6000
      {% else %}
      G90
      G0 X{x_park} Y{y_park} Z{printer.toolhead.axis_maximum.z} F6000
      {% endif %}
      {% endif %}
      M84


[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    M400 
    {% set z = params.Z|default(30)|int %}                                                   
    {% set E = (params.E|default(2))|float %}
    {% set x_park = params.X|default(200)|int %} 
    {% set y_park = params.Y|default(275)|int %} 
                                                                                  
    {% if (printer.gcode_move.position.x) <= (x_park+1) and (printer.gcode_move.position.y) >= (y_park-1) %}
      M400
    {% else %}
      {% set position = printer.gcode_move.gcode_position %}
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_x VALUE="{position.x}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_y VALUE="{position.y}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_z VALUE="{position.z}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_e VALUE="{E}"
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}   
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed_temp VALUE={printer['heater_bed'].target}  
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=sfan VALUE={printer["fan_generic _Secondary_Fan"].speed*255} 
        SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=afan VALUE={printer["fan_generic auxiliary_fan"].speed*255}
        SAVE_GCODE_STATE NAME=timelapse_state_a
        M83
        G91
      {% if (printer.gcode_move.position.z+5) <  printer.toolhead.axis_maximum.z  %}
        G1 E-2 X3 Z1 F2100
        G1 Z4 F600
      {% endif %}
        SAVE_GCODE_STATE NAME=timelapse_state_b
        G90
      {% if (printer.gcode_move.position.z+5) < z %}
        G1 Z{z+5} X{x_park} Y{y_park}  F6000
        G1 X{x_park-66} Y{y_park} E-1 F6000 
      {% else %}
        G1 X{x_park} Y{y_park} F6000
        G1 X{x_park-66} Y{y_park} E-1 F6000 
      {% endif %}
        M400
        M25
        SET_IDLE_TIMEOUT TIMEOUT=86400
        M400
        M104 S140
        M106 S0
        M106 P2 S0
    {% endif %}
                                                           


[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
variable_bed_temp: 0
variable_saved_x: 0.0
variable_saved_y: 0.0
variable_saved_z: 0.0
variable_saved_e: 0.0
variable_sfan: 0.0
variable_afan: 0.0
gcode:
    # M24
    M117 Prepare_to_resume
    {% set e = params.E|default(2)|int %}   
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}
     {% if etemp > 0 %}
      M109 S{etemp|int}
     {% endif %} 
    
    G91
    M83
    #RESTORE_GCODE_STATE NAME=timelapse_state_b MOVE=1 MOVE_SPEED=100
    #   {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}                                                
    #   G1 Z{zhop * -1} F900
	  #   G1 E{e+0.5} F900	  
    # {% else %}                      
    #   G1 Z{zhop * -1} F900                                                     
    # {% endif %}
    
  ;===== Preheat =====================
   #  M109 S250
    ;===== Extrude Filament =====================
     M106 S100
     G4 P1000
     G1 E50 F600
     M400
     M106 S255
     G4 P1000
     #M109 S140
     M106 S0
     ;===== Cut the Filament by Scraping =====================
     G90
     G4 P1000
     G1 X170 Y275 F30000
     G1 X138 Y275 F3000
     G1 X170 Y275 F30000
     G1 X138 Y275 F3000
     G1 X195 Y275 F30000
     G1 X137 Y275 F3000
     G1 X195 Y275 F30000
     #M109 S{etemp|int}
     RESTORE_GCODE_STATE NAME=timelapse_state_b MOVE=1 MOVE_SPEED=100
     M106 S{sfan}
     M106 P2 S{afan}
    RESTORE_GCODE_STATE NAME=timelapse_state_a MOVE=1 MOVE_SPEED=60 
    SET_DISPLAY_TEXT
    M24



[gcode_macro M106]
rename_existing: M1066
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% set speed = (params.S|float / 255 if params.S is defined else 1.0) %}
    {% if 'fan0' in fan %}
       M1066 S{speed*255}
       SET_FAN_SPEED FAN=_Secondary_Fan SPEED={speed}
    {% elif 'fan2' in fan %}
       SET_FAN_SPEED FAN=auxiliary_fan SPEED={speed}
    {% elif 'fan1' in fan %}
      #  SET_FAN_SPEED FAN=_ptc_fan SPEED={speed}
    {% elif 'fan3' in fan %}
       SET_FAN_SPEED FAN=filter_fan SPEED={speed}
    {% endif %}

[gcode_macro M107]    # Add M107 macro to turn off all fans, used when canceling or ending a print
rename_existing: M1077
gcode:  
        M106 P0 S0
        M106 P1 S0
        M106 P2 S0
        
[gcode_macro G29]
gcode:
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=120
      SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=60
      BED_MESH_CLEAR
      nozzle_clean                                    # Add nozzle wiping action before leveling
      M106 S0# Yuntu machine Z-axis probing is affected by fan vibration, need to ensure fan is off
      G28 Z
      # CS_WEIGHTING_START_QUERY
      M106 S0# Yuntu machine Z-axis probing is affected by fan vibration, need to ensure fan is off
      BED_MESH_CALIBRATE
      # CS_WEIGHTING_END_QUERY
      G0 Z10 F1800
      G0 X170 Y175 F12000

[gcode_macro G30]
gcode:
      G28
      # CS_WEIGHTING_START_QUERY
      PROBE_CALIBRATE
    
####################################################################
#	Homing and Gantry Adjustment Routines
#####################################################################
[idle_timeout]
timeout: 7200
gcode:
  {% if printer[printer.toolhead.extruder].temperature > 140 %}   # Reduce the hot end temperature after 10 minutes
  {action_respond_info("Extruder powered down on idle timeout.")}
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={120}       # After pausing printing, reduce nozzle temperature to 50℃
  M84 E
  # SET_IDLE_TIMEOUT TIMEOUT=259200       # Timer duration 3 days.
  {% else %}
  TURN_OFF_HEATERS
  M84 E
  {% endif %}

[gcode_macro da_tilt]
gcode:
      G28
      screws_tilt_calculate
      M84

[gcode_macro M17]
gcode:
  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=1
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=1
      #SET_STEPPER_ENABLE STEPPER=extruder enable=1
  {% endif %}



[gcode_macro M84]
rename_existing:M84.1
gcode:

  {% if 'X' in params or 'Y' in params or 'Z' in params or 'E' in params %}
  {% if 'X' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
  {% endif %}
  {% if 'Y' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
  {% endif %}
  {% if 'Z' in params %}
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
  {% endif %}
  {% if 'E' in params %}
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}
  {% else %}
      SET_STEPPER_ENABLE STEPPER=stepper_x enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_y enable=0
      SET_STEPPER_ENABLE STEPPER=stepper_z enable=0
      SET_STEPPER_ENABLE STEPPER=extruder enable=0
  {% endif %}



[delayed_gcode KINEMATIC_POSITION]
initial_duration:3.0
gcode:
      SET_KINEMATIC_POSITION X=0 Y=0 Z=0
      BED_MESH_PROFILE LOAD=default

[gcode_macro M205]
description: Sets square corner velocity.
  Usage: M205 [X<velocity>] [Y<velocity>]
gcode:
  {% set max_square_corner_velocity = 30 %}
  {% if 'X' in params or 'Y' in params %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY="{(params.X|default(0)|float, params.Y|default(0)|float,max_square_corner_velocity)|min}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro M203]
description: Sets maximum velocity.
  Usage: M203 [X<velocity>] [Y<velocity>]
gcode:
  {% if 'X' in params or 'Y' in params %}
    {% set velocity = (params.X|default(params.Y)|float,
                       params.Y|default(params.X)|float,500)|min %}
    SET_VELOCITY_LIMIT VELOCITY="{velocity}"
  {% else %}
    SET_VELOCITY_LIMIT
  {% endif %}


[gcode_macro m600]
description: Pauses the current print.
  Usage: M600 [B<beeps>] [E<pos>] [L<pos>] [R<temp>] [U<pos>] [X<pos>] [Y<pos>]
              [Z<pos>]
gcode:
  PAUSE P=2{% for k in params|select("in", "BEXYZ") %}{
      ' '~k~'="'~params[k]~'"'}{% endfor %}



[gcode_macro m300]
description: Emits and audible beep.
  Usage: M300 [P<duration>] [S<frequency>]
gcode:
  {% set settings = printer.configfile.settings %}
  {% if "output_pin beeper" in printer %}
    {% set P = (params.P|default(100)|int, 0)|max %}
    {% set S = (params.S|default(1000)|int, 10000)|min %}
    SET_PIN PIN=beeper VALUE={
        settings["output_pin beeper"].scale|default(1.0) * 0.5
      }{% if settings["output_pin beeper"].pwm %} CYCLE_TIME={
        1.0 / S }{% endif %}
    G4 P{P}
    SET_PIN PIN=beeper VALUE=0
  {% else %}
    {action_respond_info(
       "M300 is disabled. To enable create an [output_pin beeper] config.")}
  {% endif %}
  

  
[gcode_macro M109]
rename_existing: M99109
gcode:
    #  SAVE_VARIABLE VARIABLE=htemp VALUE='{printer.extruder.temperature}'
    {% set s = params.S|float %}
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+2}   ; Wait for hotend temp (within 1 degree)
    {% endif %}
    
[gcode_macro M190]
rename_existing: M99190
gcode:
    {% set s = params.S|float %}
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   ; Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+2}  ; Wait for bed temp (within 1 degree)
    {% endif %}


[gcode_macro _move_to_collection_box]
gcode:
  G28
  M400
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400
[gcode_macro _move_to_collection_box_no_g28]
gcode:
  G90
  M400
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400
[gcode_macro extru_fila_work_flow_1]
gcode:
  M400
  M106 S0
  SET_VELOCITY_LIMIT VELOCITY=650
  SET_VELOCITY_LIMIT ACCEL=15000
  G28
  ;===== Move to the Material Collection Area =====================
  G90
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400
  M109 S250
[gcode_macro _move_to_collection_box_by_liu]
gcode:
  ;===== Lift and return to zero =====================
  G91
  G1 Z5 F120
  G90
  G28
  M400
  ;===== Move to discharge port =====================
  G90
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400
[gcode_macro _move_to_collection_box_before_print_by_liu]
gcode:
  G28
  G90
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400

[gcode_macro _move_to_collection_box_after_fila_out]
gcode:
  ;by_liu
  M104 S140
  SET_VELOCITY_LIMIT VELOCITY=650
  SET_VELOCITY_LIMIT ACCEL=15000
  ;===== Move to the Material Collection Area =====================
  G91
  G1 Z0.4 F600
  M400
  G90
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400

[gcode_macro nozzle_clean_before_resume_by_liu]
gcode:
  G4 P4000
  M106 S160
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  M400

[gcode_macro _extra_fila]
gcode:
  M400
  M83
  M106 S0
  G1 E80 F300
  G1 E-2 F2400
  M400
  M106 S160
  G4 P1000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X195 Y275 F30000
  G1 X137 Y275 F3000
  M400

[gcode_macro _waste_filament]
gcode:
  G1 X158 Y276 F5000
  G1 X137 Y276 F5000
  G1 X158 Y276 F5000
  G1 X137 Y276 F5000

[gcode_macro _cut_filament]
gcode:
  G28 X Y
  G90
  G1 X266 Y100 F6000
  G1 Y10 F6000
  G1 X266 Y-1 F600
  G1 Y10 F6000
  M400
  G92 E0
  G1 E-3 F300
  G1 X250 Y10 F12000
  M400

[gcode_macro _retract_filament]
gcode:
  M83
  G1 E-5 F600
  G1 E10 F600
  G28 X Y
  G1 X50 Y150 F6000
  G1 E-5 F600
  G1 E10 F600
  G1 E-200 F600
[gcode_macro nozzle_clean]
gcode:
  ;===== Return to zero =======
  G28
  ;===== Move to discharge port to extrude =======
  G90
  G1 X200 Y276 F6000
  G1 X160 Y276 F6000
  G1 X137 Y276 F3000
  M400
  M109 S250
  M400
  M106 S65
  M83
  G1 E80 F300
  G1 E-3 F2400
  M400
  ;===== Turn on fan and heat ====
  M106 S255
  M104 S140
  G4 P5000
  ;===== Eject material ======
  G1 X170 Y276 F40000
  G1 X138 Y276 F3000
  G1 X170 Y276 F40000
  G1 X138 Y276 F3000
  G1 X141 Y276 F3000
  G4 P2000
  G1 X141 Y266 F9000
  G1 X170 Y266 F3000
  G1 X170 Y270 F3000
  G4 P1000
  M106 S255
  M104 S140
  G4 P2000
  ;===== Wipe nozzle with brush =====================
  G1 X170 Y270  Z0.2 F3000
  G1 X159 Y270  Z0.2 F6000
  G1 X181 Y270  Z0.2 F6000
  G1 X159 Y270  Z0.2 F6000
  G1 X181 Y270  Z0.2 F6000

  ;===== Scrape with PEI =====================
  G1 Z3
  G4 P500
  G1 X198 Y265.6 Z3 F3000
  G1 X198 Y265.6 Z0.1 F3000
  G1 X217 Y265.6 Z0.1 F3000
  G1 X198 Y265.6 Z0.1 F3000
  ;===== Wipe nozzle with brush =====================
  G1 Z3
  G4 P500
  G1 X170 Y270  Z0.2 F3000                                            
  G1 X159 Y270  Z0.2 F6000
  G1 X181 Y270  Z0.2 F6000
  G1 X159 Y270  Z0.2 F6000
  G1 X181 Y270  Z0.2 F6000
  ;== Seal nozzle with PEI and cool
  G1 Z3
  M400
  G1 X207 Y270  F3000
  G1 X207 Y269 F3000
  G1 X207 Y269 Z-0.2 F1500
  M106 S255
  M109 S140
  M400
[gcode_macro nozzle_clean_by_liu]
gcode:
  ;===== Extrude filament =====================
  M400
  M83
  G1 E40 F300
  M400
  ;============ Cool down, extrude, cool down ==============
  M104 S230;M104 S[Nozzle_Init_Layer_Temp]
  G1 E40 F250
  G1 E-2 F600
  M400
  M106 S120
  G4 P1000
  M109 S210;M109 S[Filament_Softening_Temp]
  ;===== Scrape material at discharge port =====================
  M106 S160
  G4 P1000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X170 Y275 F30000
  M106 S0
  M400
    
  ;===== Brush nozzle ==================
  M106 S255
  G4 P1000
  G1 X153 Y269.5 Z5 F2000
  ;===== Fine-tune Z =====================
  G1 X153 Y269.5 Z0.5 F3000
  G1 X186 Y269.5 Z0.5 F3000
  G1 X153 Y269 Z0.5 F3000
  G1 X186 Y269 Z0.5 F3000
  G1 X153 Y268.5 Z0.5 F3000
  G1 X186 Y268.5 Z0.5 F3000

  M400
  G1 Z3 F300
  M400
  ;===== Nozzle sealing and cooling =====================
  M106 S200
  M104 S180
  G1 X193 Y269 Z2 F3000
  M400
  G1 X193 Y269 Z1 F1000
  G1 X200 Y269 Z0 F80
  G1 X205 Y269 Z0 F80
  M400
  G1 X205 Y269 Z-0.2 F60
  M109 S140
  G1 X215 Y269 Z1 F600
  G1 Z5 F3000
  M400
  M106 S150

[gcode_macro nozzle_clean_after_cut]
gcode:
  ; Return to filament box
  G90
  G1 X200 Y276 F6000
  G1 X160 Y276 F6000
  G1 X137 Y276 F3000
  M109 S220
  M106 S65
  M400
  M106 S255
  M104 S140
  G4 P5000
  ; Wipe filament box
  G1 X170 Y276 F40000
  G1 X138 Y276 F3000
  G1 X170 Y276 F40000
  G1 X138 Y276 F3000
  G1 X138 Y276 F3000
  G4 P1000
  M106 S255
  M104 S140
  G4 P2000
  ; Wipe brush plate
  G1 X170 Y270  Z0.5 F3000                                            
  G1 X159 Y270  Z0.5 F6000
  G1 X181 Y270  Z0.5 F6000
  G1 X159 Y270  Z0.5 F6000
  G1 X181 Y270  Z0.5 F6000
  ; Wipe plate
  G1 Z3
  G4 P500
  G1 X198 Y265.6 Z3 F3000
  G1 X198 Y265.6 Z0.1 F3000
  G1 X217 Y265.6 Z0.1 F3000
  G1 X198 Y265.6 Z0.1 F3000
  ; Wipe brush plate
  G1 Z3
  G4 P500
  G1 X170 Y270  Z0.5 F3000                                            
  G1 X159 Y270  Z0.5 F6000
  G1 X181 Y270  Z0.5 F6000
  G1 X159 Y270  Z0.5 F6000
  G1 X181 Y270  Z0.5 F6000
  ; Cooling
  G1 Z3
  M400
  G1 X207 Y270  F3000
  G1 X207 Y269 F3000
  G1 X207 Y269 Z-0.2 F1500
  M106 S255
  M109 S140
  M400



[gcode_macro clean_fila_after_extru]
gcode:
  ;===== Cut the Filament by Scraping =====================
  M104 S140
  M106 S160
  G4 P3000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X195 Y275 F30000
  M400
  M106 S0
  M104 S0
  ;===== Move to the Material Collection Area =====================
  G90
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400




[gcode_macro _move_to_wait_for_cut_fila]
gcode:
  G1 X200 Y260 F6000
  G1 Y30 F6000
  M400
  G1 X260 F6000

[gcode_macro cut_without_loosen]
gcode:
  M400
  G90
  G1 X260 Y30 F6000
  M400
  G1 X262.7 Y30 F600;
  M400
  G1 X262.7 Y-0.5 F600
  M400

[gcode_macro first_pumpback_fila_after_cut]
gcode:
  G92 E0
  G1 E-3 F600
  M400

  G91
  G1 X-10  F600
  M400
  G90
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400

[gcode_macro second_pumpback_fila_after_cut]
gcode:
  G92 E0
  G1 E-80 F600
  M400

[gcode_macro STEPPER_MONITOR]
gcode:
  RESPOND PREFIX="Stepper Status — " MSG="x"
  DUMP_TMC STEPPER=stepper_x
  RESPOND PREFIX="Stepper Status — " MSG="y"
  DUMP_TMC STEPPER=stepper_y
  RESPOND PREFIX="Stepper Status — " MSG="z"
  DUMP_TMC STEPPER=stepper_z
  RESPOND PREFIX="Stepper Status — " MSG="queried"
