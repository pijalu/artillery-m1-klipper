# =================================
# Artillery M1 Pro - Printer config
# =================================
#
# =========== Changelog ===========
# v1.0 - Daniel Sauvage - Reorganized/Rewrote original Artillery M1 macros
#

# See docs/Config_Reference.md for a description of parameters.
#brightness = 155
[include MKS_THR.cfg]
[include MCU_ID.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include diy_start_print.cfg]

# Obico
[include moonraker_obico_macros.cfg]

# UI: Fluidd
[include fluidd.cfg]
# UI: mainsail
# [include mainsail.cfg]


[force_move]
enable_force_move : True

#WEIGHTING_DEBUG_QUERY Zoff
[probe_air]
sensor_type: c_sensor
sclk_pin: THR:PB13
dout_pin:THR:PB12
voltage: 4.95
delta_v:0.05  #0.1
z_offset: -0.17 #-0.18
probe_accel:10
speed:3 #5
samples:3
lift_speed:10
sample_retract_dist:0.3
samples_result: average
samples_tolerance: 0.02
samples_tolerance_retries: 10

[stepper_x]
step_pin: PC10
dir_pin: !PA15
enable_pin: !PD2
microsteps: 16
rotation_distance: 40.0
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin:!PC2#!MKS_THR:gpio24
endstop_pin:tmc2209_stepper_x:virtual_endstop
position_min: -2.0#改为浮点数，防止浮点计算报错
position_endstop: -2.0
position_max: 280.0
homing_speed:50
homing_retract_dist:0
homing_positive_dir:false
# step_pulse_duration:0.0000001

[stepper_y]
step_pin: PB4
dir_pin: !PB3
enable_pin: !PB7
microsteps: 16
rotation_distance: 40.0
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin:!PB23
endstop_pin:tmc2209_stepper_y:virtual_endstop
position_min: -2.0
position_endstop:-2.0
position_max:280.0
homing_speed:50
homing_retract_dist:0
homing_positive_dir:false
# step_pulse_duration:0.0000001

[stepper_z]
step_pin: PB9
dir_pin: !PB8
enable_pin: !PC15
microsteps: 64
rotation_distance: 8.0
full_steps_per_rotation: 200
gear_ratio: 3:2
# endstop_pin:!PC2#!MKS_THR:gpio25#!PB8 ## probe:z_virtual_endstop for Z-max; endstop have'!' is NO
endstop_pin:probe:z_virtual_endstop
# position_endstop:0
position_max: 265.0
position_min: -5.0
homing_speed: 5
homing_retract_dist: 4
second_homing_speed: 5

[extruder]
step_pin:THR:PB9#gpio5#!PC4
dir_pin:!THR:PB8#gpio4#PC5
enable_pin:!THR:PC15#!PA4
microsteps:16
rotation_distance: 32.6919	#Bondtech 5mm Drive Gears
gear_ratio: 65:9
#rotation_distance: 16.15	#Bondtech 5mm Drive Gears
#gear_ratio: 50:17
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.750
min_temp: -100
max_temp: 330
heater_pin:THR:PB3
sensor_type: EPCOS 100K B57560G104F
sensor_pin: THR:PA0
max_power: 1.0
pwm_cycle_time: 0.1#0.001
#control:pid
#pid_kp:13.320
#pid_ki:1.345
#pid_kd:32.967
smooth_time: 1
pressure_advance: 0.042  #0.025  修改默认压力提前值，0.025太小，边角有突出，  机器模型散热风扇风量太小，需要开辅助散热风扇，不然不同速度之间的压力提前差异很大
pressure_advance_smooth_time: 0.02
max_extrude_cross_section:42
instantaneous_corner_velocity: 10.000
max_extrude_only_distance: 1000
max_extrude_only_velocity:5000
max_extrude_only_accel:5000
# step_pulse_duration:0.0000001
min_extrude_temp:0

[verify_heater extruder]
max_error: 100
check_gain_time:20
hysteresis: 5# 波动超过10度才报错，挤出来说，比较危险,待商榷#2025年3月31日 云图发的新参数，验证中
heating_gain: 2

[heater_bed]
heater_pin: PA10#PA10
sensor_type: NTC 100K MGB18-104F39050L32#EPCOS 100K B57560G104F
# pullup_resistor: 2990
sensor_pin: PA0
max_power: 1.0
smooth_time: 3.5
#control = pid
#pid_kp = 71.372
#pid_ki = 1.629
#pid_kd = 781.518
min_temp: -100
max_temp: 130

[verify_heater heater_bed]
max_error: 200
check_gain_time:100
hysteresis: 10
heating_gain: 2

[heater_generic chamber]
heater_pin:PA9
max_power:1.0
sensor_type:NTC 100K MGB18-104F39050L32
sensor_pin:PA1

control = pid
#max_delta: 1.0
pid_Kp=63.418 
pid_Ki=1.342 
pid_Kd=749.125

min_temp:-100
max_temp:100

[verify_heater chamber]
max_error: 300
check_gain_time:600#6分钟加热1度，有点危险，存在热失控的可能，待商榷#2025年3月31日 云图发的新参数，验证中
hysteresis: 10#2025年3月31日 云图发的新参数，验证中
heating_gain: 1

[respond]
default_type: echo
default_prefix: echo:

[virtual_sdcard]
path: /home/mks/printer_data/gcodes

[print_stats]

[gcode_move]

[pause_resume]
recover_velocity: 50.0 

[fan_generic filter_fan]
pin:PC8
shutdown_speed:0
cycle_time:0.001

#辅助风扇
[fan_generic auxiliary_fan]
pin:PC9
shutdown_speed:0
cycle_time:0.001

[heater_fan _ptc_fan]
pin:PA8
tachometer_pin:PC7
tachometer_ppr:2
shutdown_speed:0
tachometer_poll_interval: 0.0001
heater:chamber
heater_temp:40.0

#部件风扇1
[fan]
pin: THR:PB6
tachometer_pin:THR:PA8
tachometer_ppr:2
shutdown_speed:0
tachometer_poll_interval: 0.0001

#部件风扇2
[fan_generic _Secondary_Fan]
pin: THR:PB4
tachometer_pin:THR:PA10
tachometer_ppr:2
shutdown_speed:0
tachometer_poll_interval: 0.0001

#散热片风扇
[heater_fan hotend_fan]
pin:THR:PB5
tachometer_pin:THR:PA9
tachometer_ppr:2
shutdown_speed:0
fan_speed: 1.0
tachometer_poll_interval: 0.0001

#####################################################################
# 	Probe
#####################################################################


[printer]
kinematics:corexy
max_velocity: 500
max_accel: 5000
# max_accel_to_decel: 10000
minimum_cruise_ratio: 0.5
max_z_velocity: 15
max_z_accel: 100
square_corner_velocity:15.0

[input_shaper]
#shaper_freq_x: 66.66
#shaper_freq_y: 42.05
#shaper_type_x: mzv
#shaper_type_y: ei
#damping_ratio_x: 0.1
#damping_ratio_y: 0.1

[bed_mesh]
speed:300
horizontal_move_z:3
mesh_min:5,5        
mesh_max:250,250        
probe_count:10,10
algorithm:bicubic
bicubic_tension:0.2
move_check_distance:3.0
split_delta_z: .02
mesh_pps: 4,4
fade_start:5.0
fade_end:30.0 

[tmc2209 stepper_x]
uart_pin: PC11
run_current: 1.0 #1.0 #1.06
# hold_current: 0.8
interpolate: true
stealthchop_threshold:0
diag_pin:^PC12
driver_SGTHRS:120

[tmc2209 stepper_y]
uart_pin: PB5
run_current: 1.0 #1.0  #1.06
# hold_current: 0.8
interpolate: true
stealthchop_threshold:0
diag_pin:^PB6
driver_SGTHRS:120

[tmc2209 stepper_z]
uart_pin: PC13
run_current: 0.7# 1.1            #数据手册上的额定电流为1A，设置为0.7
# hold_current: 0.8
interpolate: True
stealthchop_threshold: 999999
diag_pin:^PC14
# driver_SGTHRS:60

[tmc2209 extruder]
uart_pin:THR:PC13#PC11
run_current:0.9#1.0 #1.2
#hold_current: 0.5
# sense_resistor: 0.110
stealthchop_threshold:0 ;999999
interpolate: true

[lis2dw]
cs_pin:THR:PA4
# spi_software_sclk_pin:THR:PA5
# spi_software_mosi_pin:THR:PA7
# spi_software_miso_pin:THR:PA6
spi_bus:spi1
spi_speed:9000000
axes_map: y, -z, x

[resonance_tester]
accel_chip:lis2dw
accel_per_hz:150    #增加共振加速度频率，增加共振能量，以获取更准确的整形器；缺点就是振动测试过程机器振动很大
probe_points:
   125, 125, 10

[display_status]

[screws_tilt_adjust]
screw1: 133,133
screw1_name: center
screw2: 34,34
screw2_name: front left screw
screw3: 233,34
screw3_name: front right screw
screw4: 34,233
screw4_name: rear left screw
screw5: 233,233
screw5_name: rear right screw
horizontal_move_z: 5
speed: 150
screw_thread: CCW-M4

# [heater_generic chamber]
# heater_pin:PA11
# max_power:1.0
# sensor_type:NTC 100K MGB18-104F39050L32
# sensor_pin:PC13

# 断料检测 QUERY_RAW_FILAMENT_WIDTH
[hall_fila_switch]
adc1: THR:PB0
adc2: THR:PB1
enable: true
logging: true
pause_on_runout:true
runout_gcode:
        pause
        M118 Filament run out

#切刀
[hall_fila_cut]
adc1: THR:PA1
adc2: THR:PA2
enable: true
logging: true

[gcode_arcs]
resolution: 1.0     #增加圆弧指令分段长度

[exclude_object]



#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_air]
#*# z_offset = 0
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 47.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 46.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 48.496
#*# pid_ki = 0.610
#*# pid_kd = 963.866
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.025694, 0.028750, 0.117778, 0.192361, 0.245556, 0.239583, 0.197778, 0.094167, -0.014861, -0.089444
#*# 	  0.049583, 0.065694, 0.117083, 0.157500, 0.191389, 0.185139, 0.167222, 0.111528, 0.055278, 0.038611
#*# 	  0.085139, 0.069306, 0.076111, 0.095556, 0.092361, 0.095556, 0.112083, 0.102639, 0.105417, 0.148472
#*# 	  0.160417, 0.074722, 0.056806, 0.049583, 0.036389, 0.044028, 0.084444, 0.122361, 0.191944, 0.299583
#*# 	  0.185278, 0.090000, 0.055833, 0.039028, 0.024306, 0.031806, 0.086528, 0.143333, 0.247083, 0.407917
#*# 	  0.102083, 0.053472, 0.038472, 0.034167, 0.024861, 0.031944, 0.078194, 0.123472, 0.212500, 0.374861
#*# 	  0.004444, 0.002778, 0.040417, 0.070278, 0.083056, 0.083194, 0.094583, 0.099722, 0.129444, 0.218611
#*# 	  -0.102917, -0.025278, 0.072778, 0.147778, 0.183889, 0.185694, 0.153472, 0.093611, 0.034583, 0.034583
#*# 	  -0.081806, 0.046944, 0.186111, 0.309861, 0.352222, 0.338333, 0.266944, 0.133056, 0.010000, -0.056667
#*# 	  0.081944, 0.230972, 0.402500, 0.537917, 0.588611, 0.555278, 0.455833, 0.283750, 0.111250, 0.021111
#*# x_count = 10
#*# y_count = 10
#*# mesh_x_pps = 4
#*# mesh_y_pps = 4
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 5.0
#*# max_x = 249.98
#*# min_y = 5.0
#*# max_y = 249.98
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.278
#*# pid_ki = 9.066
#*# pid_kd = 26.977
