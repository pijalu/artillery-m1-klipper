
#;=================================================================================================================================

#;=============================== MACROS needed for filament manual_changes and pause-resume=======================================

#;=================================================================================================================================
[gcode_macro T0]
variable_retract: 2
variable_nozzle_temp: 250
gcode:
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°1"
     PAUSE R={nozzle_temp} 
[gcode_macro T1]
variable_retract: 2
variable_nozzle_temp: 250
gcode:

     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°2"
     PAUSE R={nozzle_temp} 
[gcode_macro T2]
variable_retract: 2
variable_nozzle_temp: 250
gcode:
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°3"
     PAUSE R={nozzle_temp} 
[gcode_macro T3]
variable_retract: 2
variable_nozzle_temp: 250
gcode:
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°4"
     PAUSE R={nozzle_temp} 
[gcode_macro T4]
variable_retract: 2
variable_nozzle_temp: 250
gcode:
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°5"
     PAUSE R={nozzle_temp} 
[gcode_macro T5]
variable_retract:2
variable_nozzle_temp: 250
gcode:
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°6"
     PAUSE R={nozzle_temp} 
[gcode_macro T6]
variable_retract: 2
variable_nozzle_temp: 250
gcode:
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°7"
     PAUSE R={nozzle_temp} 
[gcode_macro T7]
variable_retract: 2
variable_nozzle_temp: 250
gcode:
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=retract_value VALUE="{retract}"     #;Probably value to be adjusted according to the filaments used
     RESPOND PREFIX=info MSG="ðŸ“Œ Insert filament NÂ°8"
     PAUSE R={nozzle_temp} 

[gcode_macro _ADJUST_RETRACT]
description: Macro to be inserted  into ORCA printer profile: GCODE FILAMENT CHANGE
gcode:
    {% set retract = printer["gcode_macro _USER_VARIABLES"].retract_value %}
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _adjust_retract {params}____________{retract}"

    G1 E{retract} 

[gcode_macro PAUSE] 
rename_existing: BASE_PAUSE
gcode:
   RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : PAUSE {params}"
  {% if  printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused %}
    M400 
    {% set z = params.Z|default(2)|int %}                                                   
    {% set E = (params.E|default(2))|float %}
    {% set x_park = params.X|default(200)|int %} 
    {% set y_park = params.Y|default(275)|int %} 
 
    {% if (printer.gcode_move.position.x) <= (x_park+1) and (printer.gcode_move.position.y) >= (y_park-1) %}
       M400
    {% else %}
       {% set position = printer.gcode_move.gcode_position %}
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_x VALUE="{position.x}"
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_y VALUE="{position.y}"
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_z VALUE="{position.z}"
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=saved_e VALUE="{E}"
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer.extruder.target}   
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=ntemp VALUE={params.R|default(printer.extruder.target)}
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed_temp VALUE={printer.heater_bed.target}  
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=sfan VALUE={printer["fan_generic _Secondary_Fan"].speed*255} 
       SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=afan VALUE={printer["fan_generic auxiliary_fan"].speed*255}
       M104 S{params.R|default(printer.extruder.target)|float} 
       G92 E0
       SAVE_GCODE_STATE NAME=timelapse_state_a 
       BASE_PAUSE
    {% endif %}
    G90
    {% if (printer.gcode_move.position.z+5) < z %}
        G1 Z{z+2}
    {% endif %}
    M106 S0
    G1 X{x_park} Y{y_park} F6000
    G1 X{x_park-62} Y{y_park} E-0.5 F6000 
    M400
    M25
    M104 S0
    M106 P2 S0
    M400
    M300 P 1200 S400
    SET_FILAMENT_SENSOR SENSOR=hall_fila_switch ENABLE=0
    SET_IDLE_TIMEOUT TIMEOUT=43200 
  {% else %}
      respond TYPE=echo MSG="Not printing or already paused"
  {% endif %}



[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 250
variable_ntemp: 250
variable_bed_temp: 60
variable_saved_x: 0.0
variable_saved_y: 0.0
variable_saved_z: 0.0
variable_saved_e: 0.0
variable_sfan: 0.0
variable_afan: 0.0
gcode:
   RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : RESUME {params}"
   dump_variables
    {% if printer.pause_resume.is_paused %}
#    dump_variables
        G90
#       G1 X200 Y262 Z{saved_z+2} F8000 
        G1 Z{saved_z+2} F8000
        M400
        M109 S{ntemp|int} F=1
#        G1 Y{saved_y} F8000
#        G1 X{saved_x} F8000
        M400 
        RESTORE_GCODE_STATE NAME=timelapse_state_a MOVE=1 MOVE_SPEED=800
        SET_FILAMENT_SENSOR SENSOR=hall_fila_switch ENABLE=1
        M106 S{sfan}
        M106 P2 S{afan}
        M109 S{ntemp|int} F=1
        M400 
        SET_DISPLAY_TEXT
        M24
        CLEAR_PAUSE
    {% else %}
          respond TYPE=echo  MSG="Not in Pause"        
    {% endif %}


[gcode_macro _waste_filament]
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _waste_filament {params}"
    {% if printer.pause_resume.is_paused %}
        G90
        M400
        G1 X137 Y275 F3000
        M109 S{(printer["gcode_macro RESUME"].ntemp)|float} F=1 
        M400
        G90
        M83
        M106 S80
        G1 E80 F300
        G1 E-3 F600
        M400
        M106 S255
        G4 P1000
        M104 S140
        G4 P1000
        G1 X170 Y275 F30000
        G1 X138 Y275 F3000 
        G1 X170 Y275 F30000
        G1 X138 Y275 F3000
        G1 X170 Y275 F30000
        M400
        M106 S255
        G4 P1200
        G1 X153 Y269.5 Z5 F2000
        G1 X153 Y269.5 Z0.3 F3000
        G1 X186 Y269.5 Z0.3 F3000
        G1 X153 Y269 Z0.3 F3000
        G1 X186 Y269 Z0.2 F3000
        G1 X153 Y268.5 Z0.2 F3000
        G1 X186 Y268.5 Z0.1 F3000
        M400
        G1 Z3 F300
        M400
        M106 S220
        G1 X193 Y269 Z2 F3000
        M400
        G4 P1200
        G1 X193 Y269 Z1 F1000
        G1 X200 Y269 Z0 F80
        G1 X205 Y269 Z0 F80
        M400
        G1 X205 Y269 Z-0.2 F60
        G1 X215 Y269 Z1 F600
        G1 Z5 F3000
        M400
        G1 E-3 F800
        M109 S{(printer["gcode_macro RESUME"].ntemp)|float} F=1
        RESUME
    {% endif %}





[gcode_macro FILAMENT_CHANGE]
description:
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : FILAMENT_CHANGE] {params}"
    {% set s = (printer["gcode_macro RESUME"].etemp)|float %}
    {% set r = (printer["gcode_macro RESUME"].ntemp)|float %}
    {% if s > 180 %}
          M104 S{(printer["gcode_macro RESUME"].etemp)|float}
          TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+2}
          G90 
          G1 X200 Y260 F6000 ; go to cut filament
          G1 X260 Y30 F6000
          G1 X260 F6000
          M400
          G1 X262.7 Y30 F600 ;  cut filament
          M400
          G1 X262.7 Y-0.5 F600 
          M400
          G92 E0
          G1 E-3 F600
          M400
          G91
          G1 X-10  F600
          M400
          G90
          G1 X200 Y260 F6000
          G1 X200 Y275 F6000
          G1 X160 Y275 F6000
          G1 X137 Y275 F3000
          M400
          G92 E0
          G1 E-80 F600
          M400
          M104 S{(printer["gcode_macro RESUME"].ntemp)|float}
          TEMPERATURE_WAIT SENSOR=extruder MINIMUM={r-2} MAXIMUM={r+2}
    {% endif %}


[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
      RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : CANCEL_PRINT {params}"

      SET_DISPLAY_TEXT
      {% set RUN_VELOCITY = printer.configfile.settings['printer'].max_velocity|float %}
      {% set RUN_ACCEL    = printer.configfile.settings['printer'].max_accel|float %}
      # {% set RUN_DECEL    = printer.configfile.settings['printer'].max_accel_to_decel|float %}
      SET_VELOCITY_LIMIT VELOCITY={RUN_VELOCITY} ACCEL={RUN_ACCEL} #ACCEL_TO_DECEL={RUN_DECEL}
      {% set z = params.Z|default(100)|int %}  
      {% set x_park = params.X|default(printer.toolhead.axis_minimum.x+5)|int %} 
      {% set y_park = params.Y|default(printer.toolhead.axis_minimum.y+5)|int %} 

      SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} 
      SDCARD_RESET_FILE
      CLEAR_PAUSE
      M400
      M220 S100
      M221 S100
      G91
      M83
      G1 E-1.0 F1200
      TURN_OFF_HEATERS
      M106 S0
      M141 S0
      M106 P2 S0
      M106 P1 S0
      M106 P3 S0
      M107
      {% if (printer.gcode_move.position.z+5) < z %}
      G90
      G0 X{x_park} Y{y_park} Z{z+5} F6000
      {% endif %}
      {%if (printer.gcode_move.position.z+5) >= z %}
      {%if (printer.gcode_move.position.z+5) < printer.toolhead.axis_maximum.z %}
      G91
      G1 Z5 F300
      G90
      G0 X{x_park} Y{y_park} F6000
      {% else %}
      G90
      G0 X{x_park} Y{y_park} Z{printer.toolhead.axis_maximum.z} F6000
      {% endif %}
      {% endif %}
      M84


#;========================================================= END MANUAL-CHANGE =================================================================

#;==============================================================================================================================================

#;==========================================================UNLOAD BUTTON SCREEN  ==============================================================

[gcode_macro _move_to_collection_box_by_liu] 
description: CALL from screen bouton UNLOAD

gcode:
  {% if  not(printer.idle_timeout.state == "Printing" and not printer.pause_resume.is_paused) %}
      RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _move_to_collection_box_by_liu {params}"
        G4 S5
      {% set flag = 1 %}
      SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_flag VALUE={flag}
      {% set temp= printer.extruder.target|float %}
      M104 S{temp}
      SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_temp VALUE={temp}
      {% if  not(printer['toolhead'].homed_axes == "xyz") %} 
           G28     #necessaire pour appel depuis ecran
      {% endif %}
      G91
      G1 Z5 F120
      G90
      M400
#      G1 X200 Y260 F6000
#      G1 X200 Y275 F6000
#      G1 X160 Y275 F6000
#     G1 X137 Y275 F3000
#     M400 
  {% else %}
      RESPOND PREFIX=info MSG="ðŸ“ŒImpossible, the printer prints or paused, Use change filament."
  {% endif %}

[gcode_macro _move_to_wait_for_cut_fila]
description: use only from screen BUTTON UNLOAD
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _move_to_wait_for_cut_fila {params}______________{flag}"

   {% if  printer['gcode_macro _USER_VARIABLES'].unload_flag == 1 %}
      {% set temp= (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %}
      {% if temp > 180 %}
         M104 S{temp|float}
      {% endif %}
        G90
        G1 X200 F6000
        G1 X200 Y30 F6000
        G1 Y30 F6000
        M400
        G1 X260 F6000
   {% endif %}


[gcode_macro _cut_filament]
description: use only from screen BUTTON UNLOAD
gcode:
   RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _cut_filament {params}_______________________{temp}"

  {% if  printer['gcode_macro _USER_VARIABLES'].unload_flag == 1 %}
       G90
       G1 X266 Y100 F6000
       G1 Y10 F6000
       G1 X266 Y-1 F600
       G1 Y10 F6000
       M400
       G92 E0
       {% set temp= (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %}
       {% if temp > 180 %}
           M104 S{temp|float}
           TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp-2} MAXIMUM={temp+2}
           G1 E-3 F300
       {% endif %}
       G1 X250 Y10 F12000
       M400
  {% endif %}

[gcode_macro cut_without_loosen]
description: use only from screen BUTTON UNLOAD
gcode:

  {% if  printer['gcode_macro _USER_VARIABLES'].unload_flag == 1 %}
      {% set temp= (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %}
      RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : cut_without_loosen {params}______________{temp}"
      M400
      G90
      G1 X260 Y30 F6000
      M400
      G1 X262.7 Y30 F600;
      M400
      G1 X262.7 Y-0.5 F600
      M400
      M104 S{temp|float}
  {% endif %}

[gcode_macro first_pumpback_fila_after_cut]
description: only use from screen BUTTON UNLOAD
gcode:
  RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : first_pumpback_fila_after_cut {params}"

  {% if  printer['gcode_macro _USER_VARIABLES'].unload_flag == 1 %}
     {% set temp= (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %}
     {% if temp > 180 %}
        M104 S{temp|float}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp-2} MAXIMUM={temp+2}
        G92 E0
        G1 E-3 F600
     {% endif %}
     M400
     M400
     G90
     G1 X200 Y260 F6000
     G1 X200 Y275 F6000
     G1 X160 Y275 F6000
     G1 X137 Y275 F3000
     M400
  {% endif %}

[gcode_macro second_pumpback_fila_after_cut]
description: only use from screen BUTTON UNLOAD
gcode:
  RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : second_pumpback_fila_after_cut {params}"

  {% if printer['gcode_macro _USER_VARIABLES'].unload_flag == 1 %}
      {% set temp= (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %} 
      {% if temp > 180 %}
          M104 S{temp|float}
          TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp-2} MAXIMUM={temp+2}
          {% endif %}
          G92 E0
          G1 E-80 F600
          M104 S0
          M400

  {% endif %} 
  G90   
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_temp VALUE=0
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_flag VALUE=0
 
  
  #;================================================= END UNLOAD BUTTON SCREEN====================================================
  

  #;==============================================================================================================================

#;======================================     SCREEN BUTTON LOAD         ==========================================================

#;================================================================================================================================

[gcode_macro extru_fila_work_flow_1]
gcode:
  RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : extru_fila_work_flow_1 {params}"
  {% if  not(printer['toolhead'].homed_axes == "xyz") %} 
       G28     #necessaire pour appel depuis ecran
  {% endif %}
  M104 S{printer.extruder.target}
  {% set temp= printer.extruder.target|float %}
  {% if temp > 180 %}
     {% set flag = 1 %}
     M104 S{temp}
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_flag VALUE={flag}
     SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_temp VALUE={printer.extruder.target}
     TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp-2} MAXIMUM={temp+2}
     M400
     M106 S0
     SET_VELOCITY_LIMIT VELOCITY=650
     SET_VELOCITY_LIMIT ACCEL=15000
     {% if  printer.idle_timeout.state == "Idle" %} 
          G28     #necessaire pour appel depuis ecran
     {% endif %}
     G90
     G1 X200 Y260 F6000
     G1 X200 Y275 F6000
     G1 X160 Y275 F6000
     G1 X137 Y275 F3000
     M400
     {% else %}
       {% set flag = 0 %}
       G90
       SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_flag VALUE={flag}
       RESPOND PREFIX=info MSG="ðŸ“Œ  Please adjust the nozzle temperature."
  {% endif %} 


[gcode_macro _extra_fila]
gcode:
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _extra_fila {params}"

    {% if printer['gcode_macro _USER_VARIABLES'].unload_flag == 1 %}
        {% set temp= (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %}
        {% if temp > 180 %}
              RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _extra_fila {params}        temp={temp}"
              M104 S{temp|float}
              TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp-2} MAXIMUM={temp+2}
              M400
              M83
              M106 S0
              G1 E80 F300
              G1 E-2 F2400
              M400
              M106 S160
              G4 P1000
              G1 X170 Y275 F30000
              G1 X138 Y275 F3000
              G1 X170 Y275 F30000
              G1 X138 Y275 F3000
              G1 X195 Y275 F30000
              G1 X137 Y275 F3000
              M400
        {% endif %}
    {% endif %}
         

[gcode_macro clean_fila_after_extru]
gcode:
  RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : clean_fila_after_extru {params}"
    {% if printer['gcode_macro _USER_VARIABLES'].unload_flag == 1 %}
        {% set temp= (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %} 
        M104 S140
        M106 S160
        G4 P3000
        G1 X170 Y275 F30000
        G1 X138 Y275 F3000
        G1 X170 Y275 F30000
        G1 X138 Y275 F3000
        G1 X195 Y275 F30000
        M400
        M106 S0
        M104 S0
        G90
        G1 X200 Y260 F6000
        G1 X200 Y275 F6000
        G1 X160 Y275 F6000
        G1 X137 Y275 F3000
        M400
        SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_temp VALUE=0
  {% endif %} 
  G90   
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_temp VALUE=0
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_flag VALUE=0

#;===============================================END LOAD BUTTON SCREEN============================================================

#;=================================================================================================================================

#;=========================LOAD  FILAMENT after FILAMENT OUT=======================================================================                  

[gcode_macro _move_to_collection_box_after_fila_out]
gcode:
  RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : _move_to_collection_box_after_fila_out {params}"
  M104 S140
  SET_VELOCITY_LIMIT VELOCITY=650
  SET_VELOCITY_LIMIT ACCEL=15000
  G91
  G1 Z0.4 F600
  M400
  G90
  G1 X200 Y260 F6000
  G1 X200 Y275 F6000
  G1 X160 Y275 F6000
  G1 X137 Y275 F3000
  M400
  {% set flag= 1 %}
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_flag VALUE={flag}
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_temp VALUE={printer["gcode_macro RESUME"].ntemp}
  DUMP_VARIABLES 

   
[gcode_macro nozzle_clean_before_resume_by_liu]
gcode:
  RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : nozzle_clean_before_resume__by_liu {params}"
  M106 S200
  G4 P4000 
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  G1 X170 Y275 F30000
  G1 X138 Y275 F3000
  M106 S0
  G1 E0.5
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_flag VALUE=0
  SET_GCODE_VARIABLE MACRO=_USER_VARIABLES VARIABLE=unload_temp VALUE=0
  M400


#;================================================================================================================================

#;          Since the screen isn't properly adjusting the filament temperatures, M109 is being rerouted to the required actions.
#;          It is also diverted during filament change requests to allow for cutting and removing the filament.

#;================================================================================================================================

[gcode_macro M109]

rename_existing: M99109

gcode:
  
    RESPOND PREFIX=info MSG="ðŸ“Œ Macro executed : M109 {params}"
    {% set flag= params.F|default(FALSE) %} 
    {% set unload_temp = (printer["gcode_macro _USER_VARIABLES"].unload_temp)|float %}
    {% set unload_flag = (printer["gcode_macro _USER_VARIABLES"].unload_flag)|int %}
 
    {% if printer.pause_resume.is_paused and printer.idle_timeout.state =="Ready" %}
         {% if flag %}
                {% set s = params.S|float %}
                M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
                TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+2}   ; Wait for hotend temp (within 1 degree)
         {% else %}  
                FILAMENT_CHANGE
         {% endif %}
    {% else %}
         {%if unload_flag == 0 %}
             {% set s = params.S|float %}
             M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
             {% if s != 0 %}
                TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+2}   ; Wait for hotend temp (within 1 degree)
             {% endif %}
         {% endif %}
    {% endif %}